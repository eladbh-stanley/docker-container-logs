# Story 1.1 – Log Collector & Chunker

**Status:** Ready for Dev

## Story Statement
As an **SRE**, I want the MCP to stream *stdout* & *stderr* from selected Docker containers and emit clean, size-/time-bounded log chunks so that downstream components (LLM summariser, storage) receive manageable blobs.

## Acceptance Criteria
1. CLI flag `--all` or `--label <k=v>` enumerates containers.
2. Service re-attaches automatically if a container restarts.
3. Lines are read via dockerode in *follow* mode with < 250 ms latency.
4. ANSI colour codes & control characters are stripped.
5. Secrets matching regex list (AWS keys, hex ≥ 12 chars, JWT) are replaced by `**REDACTED**`.
6. Chunk emitted every **30 s** OR when buffer > **8 KB**, whichever first.
7. Each chunk has metadata: `container_id`, `ts_start`, `ts_end`, `size_bytes`, `chunk_id`.
8. Graceful **SIGTERM** flushes any residual buffer.
9. Unit tests simulate 2 000 lps and confirm no data loss, ≤ 5 % CPU at target rate.

## Dev Notes
* Docker SDK reference: `[Source: architecture/component-descriptions.md#LC]`
* Chunking parameters & redaction rules: `[Source: architecture/component-descriptions.md#CH]`
* Performance envelope: `[Source: architecture/technology-stack.md]`

## Tasks / Subtasks
1. [ ] (AC 1, 2) Implement container discovery & resilient attachment with dockerode.
2. [ ] (AC 3) Stream logs in async/await; ensure < 250 ms delay.
3. [ ] (AC 4, 5) Strip ANSI & apply secret-redaction regex.
4. [ ] (AC 6, 7) Buffer and flush chunks; assign incremental `chunk_id`.
5. [ ] (AC 8) Handle SIGTERM to drain buffer and close streams.
6. [ ] (AC 9) Write unit tests with vitest using dockerode mocks.
7. [ ] Update Prometheus metric `log_lines_total`.

## Project Structure Notes
No conflicts with defined paths – new module `src/mcp/collector.py` aligns with backend structure.

## Checklist Results
Story-draft checklist executed on 2025-07-16 – all items passed. Story approved for development. 

### Dev Agent Record

**Agent Model Used:** gpt-4o

**Debug Log References:** N/A – initial implementation.

**Completion Notes:**
- Architecture migrated from Python to Node.js stack
- Previous Python implementation removed
- Ready for Node.js implementation with dockerode, vitest, etc.

**File List:**
- (To be created with Node.js implementation)

**Change Log:**
| Date | Description |
|------|-------------|
| 2025-07-16 | Initial implementation of Log Collector & Chunker |

**Status:** In Progress 